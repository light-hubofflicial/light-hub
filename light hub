-- Light Hub v2 | Fun Tab & Fling Removed | Left Tabs | FOV Persistent & Max 200 --
-- Press K / Insert or click LH to toggle menu

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local player = Players.LocalPlayer

local flying = false
local noclipping = false
local infJump = false
local espEnabled = false
local fastWalk = false
local fullbright = false
local fovEnabled = false

local flySpeed = 50
local normalWS = 16
local fastWS = 100

local BV, BG, flyConn, noclipConn = nil, nil, nil, nil
local speedConn = nil
local espObjects = {}

local savedBrightness = Lighting.Brightness
local savedClockTime = Lighting.ClockTime
local savedFogEnd = Lighting.FogEnd
local savedGlobalShadows = Lighting.GlobalShadows
local savedAmbient = Lighting.Ambient

-- FOV variables
local originalFOV = workspace.CurrentCamera.FieldOfView
local currentFOV = originalFOV
local minFOV = 30
local maxFOV = 200

local function getChar() return player.Character end
local function getHumanoid() local c = getChar(); return c and c:FindFirstChild("Humanoid") end
local function getRoot() local c = getChar(); return c and c:FindFirstChild("HumanoidRootPart") end

-- Cleanup on respawn
player.CharacterAdded:Connect(function()
    if flying then stopFly() end
    if noclipping then stopNoclip() end
    fastWalk = false
    if speedConn then speedConn:Disconnect(); speedConn = nil end
    if getHumanoid() then getHumanoid().WalkSpeed = normalWS end

    if fovEnabled then
        workspace.CurrentCamera.FieldOfView = currentFOV
    end
end)

-- Make FOV persistent (doesn't reset when opening menus, shops, etc.)
RunService.RenderStepped:Connect(function()
    if fovEnabled and workspace.CurrentCamera then
        workspace.CurrentCamera.FieldOfView = currentFOV
    end
end)

workspace.CurrentCamera:GetPropertyChangedSignal("FieldOfView"):Connect(function()
    if fovEnabled then
        workspace.CurrentCamera.FieldOfView = currentFOV
    end
end)

-- FLY
local function startFly()
    if flying then return end
    local root = getRoot()
    local hum = getHumanoid()
    if not root or not hum then return end
    flying = true
    hum.PlatformStand = true
    BV = Instance.new("BodyVelocity")
    BV.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    BV.Velocity = Vector3.new(0,0,0)
    BV.Parent = root
    BG = Instance.new("BodyGyro")
    BG.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
    BG.P = 12500
    BG.D = 500
    BG.Parent = root
    flyConn = RunService.Heartbeat:Connect(function()
        if not flying or not getRoot() then stopFly(); return end
        BG.CFrame = workspace.CurrentCamera.CFrame
        local move = Vector3.new()
        if UserInputService.KeyboardEnabled then
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += workspace.CurrentCamera.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= workspace.CurrentCamera.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= workspace.CurrentCamera.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += workspace.CurrentCamera.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0,1,0) end
        end
        if move.Magnitude > 0 then
            BV.Velocity = move.Unit * flySpeed
        else
            BV.Velocity = Vector3.new(0,0,0)
        end
    end)
end

local function stopFly()
    flying = false
    if flyConn then flyConn:Disconnect(); flyConn = nil end
    if BV then BV:Destroy(); BV = nil end
    if BG then BG:Destroy(); BG = nil end
    local hum = getHumanoid()
    if hum then hum.PlatformStand = false end
end

-- NOCLIP
local function startNoclip()
    if noclipping then return end
    noclipping = true
    noclipConn = RunService.Stepped:Connect(function()
        local char = getChar()
        if char then
            for _, p in pairs(char:GetDescendants()) do
                if p:IsA("BasePart") then p.CanCollide = false end
            end
        end
    end)
end

local function stopNoclip()
    noclipping = false
    if noclipConn then noclipConn:Disconnect(); noclipConn = nil end
end

-- INFINITE JUMP
UserInputService.InputBegan:Connect(function(i, gp)
    if gp or not infJump then return end
    if i.KeyCode == Enum.KeyCode.Space then
        local h = getHumanoid()
        if h then h:ChangeState(Enum.HumanoidStateType.Jumping) end
    end
end)

-- SPEED
local function applySpeed()
    local hum = getHumanoid()
    local root = getRoot()
    if not hum or not root then return end
    hum.WalkSpeed = fastWalk and fastWS or normalWS
    if speedConn then speedConn:Disconnect() end
    speedConn = RunService.Heartbeat:Connect(function()
        if fastWalk and hum.MoveDirection.Magnitude > 0 then
            root.Velocity = hum.MoveDirection * fastWS + Vector3.new(0, root.Velocity.Y, 0)
        end
    end)
end

local function toggleSpeed()
    fastWalk = not fastWalk
    applySpeed()
end

-- FULLBRIGHT
local function startFullbright()
    if fullbright then return end
    fullbright = true
    savedBrightness = Lighting.Brightness
    savedClockTime = Lighting.ClockTime
    savedFogEnd = Lighting.FogEnd
    savedGlobalShadows = Lighting.GlobalShadows
    savedAmbient = Lighting.Ambient
    Lighting.Brightness = 3
    Lighting.ClockTime = 12
    Lighting.FogEnd = 100000
    Lighting.GlobalShadows = false
    Lighting.Ambient = Color3.fromRGB(255, 255, 255)
end

local function stopFullbright()
    fullbright = false
    Lighting.Brightness = savedBrightness
    Lighting.ClockTime = savedClockTime
    Lighting.FogEnd = savedFogEnd
    Lighting.GlobalShadows = savedGlobalShadows
    Lighting.Ambient = savedAmbient
end

-- ESP
local function createESP(plr)
    if plr == player or espObjects[plr] then return end
    local char = plr.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    local head = char:FindFirstChild("Head")
    if not hum or not head then return end
    local hl = Instance.new("Highlight", char)
    hl.FillColor = Color3.fromRGB(255, 0, 0)
    hl.OutlineColor = Color3.fromRGB(255, 255, 0)
    hl.FillTransparency = 0.5
    hl.OutlineTransparency = 0
    local bill = Instance.new("BillboardGui", char)
    bill.Adornee = head
    bill.Size = UDim2.new(0, 100, 0, 50)
    bill.StudsOffset = Vector3.new(0, 3, 0)
    bill.AlwaysOnTop = true
    local nameLabel = Instance.new("TextLabel", bill)
    nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = plr.DisplayName
    nameLabel.TextColor3 = Color3.new(1, 1, 1)
    nameLabel.TextStrokeTransparency = 0
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextScaled = true
    local healthLabel = Instance.new("TextLabel", bill)
    healthLabel.Size = UDim2.new(1, 0, 0.5, 0)
    healthLabel.Position = UDim2.new(0, 0, 0.5, 0)
    healthLabel.BackgroundTransparency = 1
    healthLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
    healthLabel.TextStrokeTransparency = 0
    healthLabel.Font = Enum.Font.GothamBold
    healthLabel.TextScaled = true
    healthLabel.Text = math.floor(hum.Health) .. "/" .. hum.MaxHealth
    hum.HealthChanged:Connect(function(health)
        if espObjects[plr] then
            healthLabel.Text = math.floor(health) .. "/" .. hum.MaxHealth
        end
    end)
    espObjects[plr] = {highlight = hl, billboard = bill}
end

local function removeESP(plr)
    if espObjects[plr] then
        if espObjects[plr].highlight then espObjects[plr].highlight:Destroy() end
        if espObjects[plr].billboard then espObjects[plr].billboard:Destroy() end
        espObjects[plr] = nil
    end
end

local function fullRefreshESP()
    if not espEnabled then return end
    for p, _ in pairs(espObjects) do removeESP(p) end
    espObjects = {}
    for _, p in Players:GetPlayers() do
        if p ~= player then createESP(p) end
    end
end

local function toggleESP()
    espEnabled = not espEnabled
    if espEnabled then fullRefreshESP() else for p, _ in pairs(espObjects) do removeESP(p) end espObjects = {} end
end

Players.PlayerAdded:Connect(function(p)
    if espEnabled and p ~= player then
        p.CharacterAdded:Connect(function() createESP(p) end)
    end
end)
Players.PlayerRemoving:Connect(removeESP)

task.spawn(function()
    while task.wait(5) do fullRefreshESP() end
end)

-- GUI
local function createGUI()
    local floatGui = Instance.new("ScreenGui")
    floatGui.Name = "LightHub_Float"
    floatGui.ResetOnSpawn = false
    floatGui.Parent = player:WaitForChild("PlayerGui")

    local floatBtn = Instance.new("TextButton")
    floatBtn.Size = UDim2.new(0, 60, 0, 60)
    floatBtn.Position = UDim2.new(0, 20, 0.5, -30)
    floatBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    floatBtn.Text = "LH"
    floatBtn.TextColor3 = Color3.fromRGB(255, 140, 0)
    floatBtn.Font = Enum.Font.GothamBold
    floatBtn.TextScaled = true
    floatBtn.BackgroundTransparency = 0.3
    floatBtn.Active = true
    floatBtn.Draggable = true
    floatBtn.Parent = floatGui
    Instance.new("UICorner", floatBtn).CornerRadius = UDim.new(1, 0)
    local stroke = Instance.new("UIStroke", floatBtn)
    stroke.Color = Color3.fromRGB(255, 140, 0)
    stroke.Thickness = 3

    local mainGui = Instance.new("ScreenGui")
    mainGui.Name = "LightHub_Main"
    mainGui.ResetOnSpawn = false
    mainGui.Enabled = false
    mainGui.Parent = player:WaitForChild("PlayerGui")

    local main = Instance.new("Frame")
    main.Size = UDim2.new(0, 450, 0, 380)
    main.Position = UDim2.new(0.5, -225, 0.5, -190)
    main.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    main.Active = true
    main.Draggable = true
    main.Parent = mainGui
    Instance.new("UICorner", main).CornerRadius = UDim.new(0, 12)
    local mainStroke = Instance.new("UIStroke", main)
    mainStroke.Color = Color3.fromRGB(255, 140, 0)
    mainStroke.Thickness = 2

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 35)
    title.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    title.Text = "Light Hub v2"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 20
    title.Parent = main
    Instance.new("UICorner", title).CornerRadius = UDim.new(0, 12)

    local tabPanel = Instance.new("Frame")
    tabPanel.Size = UDim2.new(0, 120, 1, -35)
    tabPanel.Position = UDim2.new(0, 0, 0, 35)
    tabPanel.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    tabPanel.Parent = main

    local movementTab = Instance.new("TextButton")
    movementTab.Size = UDim2.new(1, 0, 0, 50)
    movementTab.BackgroundColor3 = Color3.new(1, 1, 1)
    movementTab.Text = "Movement"
    movementTab.TextColor3 = Color3.new(0, 0, 0)
    movementTab.Font = Enum.Font.GothamBold
    movementTab.TextSize = 18
    movementTab.Parent = tabPanel
    Instance.new("UICorner", movementTab).CornerRadius = UDim.new(0, 8)

    local visualsTab = Instance.new("TextButton")
    visualsTab.Size = UDim2.new(1, 0, 0, 50)
    visualsTab.Position = UDim2.new(0, 0, 0, 50)
    visualsTab.BackgroundColor3 = Color3.new(0, 0, 0)
    visualsTab.Text = "Visuals"
    visualsTab.TextColor3 = Color3.new(1, 1, 1)
    visualsTab.Font = Enum.Font.GothamBold
    visualsTab.TextSize = 18
    visualsTab.Parent = tabPanel
    Instance.new("UICorner", visualsTab).CornerRadius = UDim.new(0, 8)

    local contentArea = Instance.new("Frame")
    contentArea.Size = UDim2.new(1, -120, 1, -35)
    contentArea.Position = UDim2.new(0, 120, 0, 35)
    contentArea.BackgroundTransparency = 1
    contentArea.Parent = main

    local movementContent = Instance.new("Frame")
    movementContent.Size = UDim2.new(1, 0, 1, 0)
    movementContent.BackgroundTransparency = 1
    movementContent.Visible = true
    movementContent.Parent = contentArea

    local visualsContent = Instance.new("Frame")
    visualsContent.Size = UDim2.new(1, 0, 1, 0)
    visualsContent.BackgroundTransparency = 1
    visualsContent.Visible = false
    visualsContent.Parent = contentArea

    movementTab.MouseButton1Click:Connect(function()
        movementContent.Visible = true
        visualsContent.Visible = false
        movementTab.BackgroundColor3 = Color3.new(1, 1, 1)
        movementTab.TextColor3 = Color3.new(0, 0, 0)
        visualsTab.BackgroundColor3 = Color3.new(0, 0, 0)
        visualsTab.TextColor3 = Color3.new(1, 1, 1)
    end)

    visualsTab.MouseButton1Click:Connect(function()
        movementContent.Visible = false
        visualsContent.Visible = true
        movementTab.BackgroundColor3 = Color3.new(0, 0, 0)
        movementTab.TextColor3 = Color3.new(1, 1, 1)
        visualsTab.BackgroundColor3 = Color3.new(1, 1, 1)
        visualsTab.TextColor3 = Color3.new(0, 0, 0)
    end)

    local function addRow(parent, name, toggleFunc, hasTextBox, defaultValue)
        local rowCount = #parent:GetChildren()
        local yPos = rowCount * 48 + 10
        local row = Instance.new("Frame")
        row.Size = UDim2.new(1, -20, 0, 40)
        row.Position = UDim2.new(0, 10, 0, yPos)
        row.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        row.Parent = parent
        Instance.new("UICorner", row).CornerRadius = UDim.new(0, 8)

        local label = Instance.new("TextLabel", row)
        label.Size = UDim2.new(0.35, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.Text = name .. ": OFF"
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Font = Enum.Font.GothamBold
        label.TextSize = 18

        local btn = Instance.new("TextButton", row)
        btn.Size = UDim2.new(0, 65, 0, 30)
        btn.Position = UDim2.new(1, -75, 0.5, -15)
        btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        btn.Text = "OFF"
        btn.TextSize = 18
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

        btn.MouseButton1Click:Connect(function()
            toggleFunc()
            local state = (name == "Fly" and flying) or (name == "Speed" and fastWalk) or (name == "Noclip" and noclipping) or (name == "Inf Jump" and infJump) or (name == "ESP" and espEnabled) or (name == "Fullbright" and fullbright) or (name == "FOV" and fovEnabled)
            btn.Text = state and "ON" or "OFF"
            btn.BackgroundColor3 = state and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(60, 60, 60)
            label.Text = name .. ": " .. btn.Text
        end)

        if hasTextBox then
            local box = Instance.new("TextBox", row)
            box.Size = UDim2.new(0, 55, 0, 30)
            box.Position = UDim2.new(1, -135, 0.5, -15)
            box.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
            box.Text = defaultValue
            box.TextSize = 18
            Instance.new("UICorner", box).CornerRadius = UDim.new(0, 6)
            box.FocusLost:Connect(function()
                local val = tonumber(box.Text)
                if name == "Fly" then
                    flySpeed = math.clamp(val or 50, 1, 500)
                elseif name == "Speed" then
                    fastWS = math.clamp(val or 100, 16, 500)
                    if fastWalk then applySpeed() end
                end
            end)
        end
    end

    local function addFOVRow(parent)
        local rowCount = #parent:GetChildren()
        local yPos = rowCount * 48 + 10
        local row = Instance.new("Frame")
        row.Size = UDim2.new(1, -20, 0, 40)
        row.Position = UDim2.new(0, 10, 0, yPos)
        row.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        row.Parent = parent
        Instance.new("UICorner", row).CornerRadius = UDim.new(0, 8)

        local label = Instance.new("TextLabel", row)
        label.Size = UDim2.new(0.35, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.Text = "FOV: OFF"
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Font = Enum.Font.GothamBold
        label.TextSize = 18

        local fovBox = Instance.new("TextBox", row)
        fovBox.Size = UDim2.new(0, 70, 0, 30)
        fovBox.Position = UDim2.new(1, -145, 0.5, -15)
        fovBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        fovBox.Text = tostring(math.floor(currentFOV))
        fovBox.TextColor3 = Color3.new(1,1,1)
        fovBox.TextSize = 18
        fovBox.ClearTextOnFocus = false
        Instance.new("UICorner", fovBox).CornerRadius = UDim.new(0, 6)

        local toggleBtn = Instance.new("TextButton", row)
        toggleBtn.Size = UDim2.new(0, 65, 0, 30)
        toggleBtn.Position = UDim2.new(1, -75, 0.5, -15)
        toggleBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        toggleBtn.Text = "OFF"
        toggleBtn.TextSize = 18
        Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 6)

        fovBox.FocusLost:Connect(function()
            local val = tonumber(fovBox.Text)
            if val then
                currentFOV = math.clamp(math.floor(val), minFOV, maxFOV)
                fovBox.Text = tostring(currentFOV)
            else
                fovBox.Text = tostring(currentFOV)
            end
        end)

        toggleBtn.MouseButton1Click:Connect(function()
            fovEnabled = not fovEnabled
            toggleBtn.Text = fovEnabled and "ON" or "OFF"
            toggleBtn.BackgroundColor3 = fovEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(60, 60, 60)
            label.Text = "FOV: " .. toggleBtn.Text
        end)
    end

    addRow(movementContent, "Fly", function() if flying then stopFly() else startFly() end end, true, "50")
    addRow(movementContent, "Speed", toggleSpeed, true, "100")
    addRow(movementContent, "Noclip", function() if noclipping then stopNoclip() else startNoclip() end end, false)
    addRow(movementContent, "Inf Jump", function() infJump = not infJump end, false)

    addRow(visualsContent, "ESP", toggleESP, false)
    addRow(visualsContent, "Fullbright", function() if fullbright then stopFullbright() else startFullbright() end end, false)
    addFOVRow(visualsContent)

    local function toggleMenu()
        mainGui.Enabled = not mainGui.Enabled
    end

    floatBtn.MouseButton1Click:Connect(toggleMenu)
    UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.KeyCode == Enum.KeyCode.K or input.KeyCode == Enum.KeyCode.Insert then
            toggleMenu()
        end
    end)
end

createGUI()
print("Light Hub v2 Loaded | All Features + Persistent FOV (Max 200)")
